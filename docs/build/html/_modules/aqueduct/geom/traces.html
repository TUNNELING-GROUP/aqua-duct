<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>aqueduct.geom.traces &mdash; Aqueduct 0.2.10 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2.10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Aqueduct 0.2.10 documentation" href="../../../index.html" />
    <link rel="up" title="aqueduct" href="../../aqueduct.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Aqueduct 0.2.10 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../aqueduct.html" accesskey="U">aqueduct</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for aqueduct.geom.traces</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span><span class="p">,</span> <span class="n">pdist</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">aqueduct.utils.helpers</span> <span class="kn">import</span> <span class="n">arrayify</span><span class="p">,</span><span class="n">lind</span>


<div class="viewcode-block" id="vector_norm"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.vector_norm">[docs]</a><span class="k">def</span> <span class="nf">vector_norm</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
    <span class="c1"># return np.sqrt(np.dot(V, V.conj()))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">V</span><span class="p">))</span></div>
    <span class="c1"># return np.linalg.norm(V)</span>


<div class="viewcode-block" id="triangle_angles"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.triangle_angles">[docs]</a><span class="k">def</span> <span class="nf">triangle_angles</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/questions/5122372/angle-between-points</span>
    <span class="c1"># ABC are point in the space</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">C</span> <span class="o">-</span> <span class="n">A</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">A</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">C</span> <span class="o">-</span> <span class="n">B</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">)):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">denom</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">angles</span></div>


<div class="viewcode-block" id="triangle_angles_last"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.triangle_angles_last">[docs]</a><span class="k">def</span> <span class="nf">triangle_angles_last</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
    <span class="c1"># http://stackoverflow.com/questions/5122372/angle-between-points</span>
    <span class="c1"># ABC are point in the space</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">C</span> <span class="o">-</span> <span class="n">A</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">A</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">C</span> <span class="o">-</span> <span class="n">B</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">),):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">denom</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">angles</span></div>


<div class="viewcode-block" id="triangle_height"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.triangle_height">[docs]</a><span class="k">def</span> <span class="nf">triangle_height</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
    <span class="c1"># a is head</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">triangle_angles_last</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">c</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">h</span></div>


<div class="viewcode-block" id="vectors_angle"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.vectors_angle">[docs]</a><span class="k">def</span> <span class="nf">vectors_angle</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vector_norm</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">B</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="vectors_angle_alt"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.vectors_angle_alt">[docs]</a><span class="k">def</span> <span class="nf">vectors_angle_alt</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span> <span class="o">/</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">B</span> <span class="o">/</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">B</span><span class="p">)),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span></div>


<div class="viewcode-block" id="vectors_angle_alt_anorm"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.vectors_angle_alt_anorm">[docs]</a><span class="k">def</span> <span class="nf">vectors_angle_alt_anorm</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A_norm</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span> <span class="o">/</span> <span class="n">A_norm</span><span class="p">,</span> <span class="n">B</span> <span class="o">/</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">B</span><span class="p">)),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span></div>


<div class="viewcode-block" id="vectors_angle_anorm"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.vectors_angle_anorm">[docs]</a><span class="k">def</span> <span class="nf">vectors_angle_anorm</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A_norm</span><span class="p">):</span>
    <span class="n">norm2</span> <span class="o">=</span> <span class="n">A_norm</span> <span class="o">*</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm2</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm2</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span></div>



<div class="viewcode-block" id="LinearizeOneWay"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeOneWay">[docs]</a><span class="k">class</span> <span class="nc">LinearizeOneWay</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="LinearizeOneWay.here"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeOneWay.here">[docs]</a>    <span class="k">def</span> <span class="nf">here</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">yield</span> <span class="mi">0</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sp</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_linear</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">sp</span><span class="p">:</span><span class="n">ep</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">ep</span>
                <span class="k">break</span></div></div>


<div class="viewcode-block" id="LinearizeHobbit"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeHobbit">[docs]</a><span class="k">class</span> <span class="nc">LinearizeHobbit</span><span class="p">(</span><span class="n">LinearizeOneWay</span><span class="p">):</span>


<div class="viewcode-block" id="LinearizeHobbit.and_back_again"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeHobbit.and_back_again">[docs]</a>    <span class="k">def</span> <span class="nf">and_back_again</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">e</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">here</span><span class="p">(</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="LinearizeHobbit.__call__"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeHobbit.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">here</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">and_back_again</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">and_back_again</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">linearize</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">here</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">and_back_again</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">coords</span><span class="p">[</span><span class="n">linearize</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="LinearizeRecursive"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeRecursive">[docs]</a><span class="k">class</span> <span class="nc">LinearizeRecursive</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for linearization methods classes.</span>

<span class="sd">    It implements recursive algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LinearizeRecursive.here"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeRecursive.here">[docs]</a>    <span class="k">def</span> <span class="nf">here</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Core of recursive linearization argorithm.</span>

<span class="sd">        It checks if the first, the last and the middle point are linear acoording to the criterion. The middle point is selected a point that is in the middle of lenght of the paths made by input coordinates.</span>

<span class="sd">        If these points are linear their indices are returned. Otherwise, coordinates are split into two parts. First part spans points from the first point to the middle point (inclusive) and the second parth spans points from the middle (inclusive) to the last point. Next, these two parts are submitted recursively to :meth:`here`.</span>

<span class="sd">         Results of these recursive calls are joined, redundant indecies are removed and sorted reslult is returned.</span>

<span class="sd">        :param numpy.ndarray coords: Input coordinates.</span>
<span class="sd">        :param int depth: Depth of recurence.</span>
<span class="sd">        :return: Indices of :arg:`coords` points that can be used instead of all points in visulatization.</span>
<span class="sd">        :rtype: list of int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">coords</span><span class="p">))))</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">lengths</span><span class="o">&gt;</span><span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">mp</span> <span class="o">==</span> <span class="n">sp</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">mp</span> <span class="o">==</span> <span class="n">ep</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_linear</span><span class="p">(</span><span class="n">coords</span><span class="p">[[</span><span class="n">sp</span><span class="p">,</span><span class="n">mp</span><span class="p">,</span><span class="n">ep</span><span class="p">]],</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span><span class="n">mp</span><span class="p">,</span><span class="n">ep</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">here</span><span class="p">(</span><span class="n">coords</span><span class="p">[:</span><span class="n">mp</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">e</span><span class="o">+</span><span class="n">mp</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">here</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">mp</span><span class="p">:],</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)])))</span></div>


<div class="viewcode-block" id="LinearizeRecursive.__call__"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeRecursive.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">here</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coords</span><span class="p">[</span><span class="n">here</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="TrianlgeLinearize"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.TrianlgeLinearize">[docs]</a><span class="k">class</span> <span class="nc">TrianlgeLinearize</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="TrianlgeLinearize.__init__"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.TrianlgeLinearize.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">treshold</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">treshold</span> <span class="o">=</span> <span class="n">treshold</span></div>

<div class="viewcode-block" id="TrianlgeLinearize.is_linear"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.TrianlgeLinearize.is_linear">[docs]</a>    <span class="k">def</span> <span class="nf">is_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">list_of_h</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">list_of_h</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">triangle_height</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># print list_of_h, sum(list_of_h)</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">list_of_h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">treshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div></div>


<div class="viewcode-block" id="VectorLinearize"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.VectorLinearize">[docs]</a><span class="k">class</span> <span class="nc">VectorLinearize</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for linearization methods classes.</span>

<span class="sd">    It implements vectro linearization criterion.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<div class="viewcode-block" id="VectorLinearize.__init__"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.VectorLinearize.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">treshold</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">treshold</span> <span class="o">=</span> <span class="n">treshold</span></div>

<div class="viewcode-block" id="VectorLinearize.is_linear_core"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.VectorLinearize.is_linear_core">[docs]</a>    <span class="k">def</span> <span class="nf">is_linear_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="n">depth</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method checks if input coordinates are linear acoording to the threshold and depth.</span>

<span class="sd">        It begins with calculation of the threshold. If `depth` is None it is set to 1. Current treshold is calculated with following simple equation:</span>

<span class="sd">        .. math::</span>

<span class="sd">            treshold_{current} = treshold_{initial} * (2 - 0.9^{depth})</span>

<span class="sd">        Next, in a loop over all points but the first and the last the angle is calculated between two vectors. The first one made by the point and the firs point, and the second vector made by the last and the first point. If any of the calculated angles is bigger the the treshold methods returns False; otherwise method returns True.</span>

<span class="sd">        :param numpy.ndarray coords: Coodrdinates for which linearizetion criterion is checked.</span>
<span class="sd">        :param int depth: Depth of recurence.</span>
<span class="sd">        :return: True if input coordinates are linear and False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">treshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">treshold</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">treshold</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.9</span><span class="o">**</span><span class="n">depth</span><span class="p">)</span> <span class="c1"># FIXME: magic constant!</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">V_norm</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">V_sum</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vectors_angle_anorm</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">V_sum</span><span class="p">,</span> <span class="n">V_norm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">treshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="VectorLinearize.is_linear"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.VectorLinearize.is_linear">[docs]</a>    <span class="k">def</span> <span class="nf">is_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For more detail see :meth:`is_linear_core` which is used as the criterion of linearity in this method.</span>

<span class="sd">        :param numpy.ndarray coords: Coodrdinates for which linearizetion criterion is checked.</span>
<span class="sd">        :param int depth: Depth of recurence.</span>
<span class="sd">        :return: True if input coordinates are linear and False otherwise. Criterion is checked for coordinates in normal and reverse order.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_linear_core</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_linear_core</span><span class="p">(</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div></div>


<div class="viewcode-block" id="LinearizeRecursiveVector"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.LinearizeRecursiveVector">[docs]</a><span class="k">class</span> <span class="nc">LinearizeRecursiveVector</span><span class="p">(</span><span class="n">LinearizeRecursive</span><span class="p">,</span><span class="n">VectorLinearize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ..  _simply_smooths_details:</span>

<span class="sd">    Class provides recursive linearization of coordinates with :class:`LinearizeRecursive` algorithm and the criterion of linearity implemented by :class:`VectorLinearize`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>




<div class="viewcode-block" id="diff"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.diff">[docs]</a><span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;Trace should be of np.ndarray type, </span><span class="si">%r</span><span class="s2"> submited instead.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Traces should be 2d, </span><span class="si">%d</span><span class="s2">d submited instead (trace no. </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">trace_diff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trace</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">trace_diff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">trace</span><span class="p">[</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])),</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace_diff</span><span class="p">)</span></div>


<div class="viewcode-block" id="tracepoints"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.tracepoints">[docs]</a><span class="k">def</span> <span class="nf">tracepoints</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>
    <span class="c1"># nr == 1 then midpoint is returned</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">ce</span><span class="p">,</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cb</span><span class="p">,</span> <span class="n">ce</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="midpoints"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.midpoints">[docs]</a><span class="k">def</span> <span class="nf">midpoints</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
    <span class="c1"># paths is a tuple of 2d np.arrays,</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;Paths should be of tuple type, </span><span class="si">%r</span><span class="s2"> submitted instead.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;Traces should be of numpy.ndarray type, </span><span class="si">%r</span><span class="s2"> submited instead (trace no. </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">trace</span><span class="p">),</span> <span class="n">nr</span><span class="p">)</span>
        <span class="c1"># assert len(trace.shape) == 2, &quot;Traces should be 2d, %dd submited instead (trace no. %d)&quot; %(len(trace.shape),nr)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="n">last_trace</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="c1"># find past and next trace</span>
            <span class="n">past</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">paths</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">past</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">paths</span><span class="p">[</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">next</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># calculate midpoints if relevant</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">past</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">midp</span> <span class="o">=</span> <span class="n">tracepoints</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">midp</span><span class="p">,</span> <span class="n">trace</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">midp</span> <span class="o">=</span> <span class="n">tracepoints</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">next</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">trace</span><span class="p">,</span> <span class="n">midp</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">trace</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="length_step_std"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.length_step_std">[docs]</a><span class="k">def</span> <span class="nf">length_step_std</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="derrivative"><a class="viewcode-back" href="../../../aqueduct.geom.traces.html#aqueduct.geom.traces.derrivative">[docs]</a><span class="k">def</span> <span class="nf">derrivative</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">correction</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># this correct values so after integration they are closer to expected value</span>
    <span class="c1"># This was calculated by following experiment:</span>
    <span class="c1"># w = []</span>
    <span class="c1"># for q in range(10000):</span>
    <span class="c1">#     r = np.cumsum(np.random.rand(10000))</span>
    <span class="c1">#     w.append(r[-1]/sum(list(traces.derrivative(r))))</span>
    <span class="c1"># np.mean(w) # w is of narmal distribution</span>

    <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">correction</span><span class="c1"># begin</span>
        <span class="k">elif</span> <span class="n">nr</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">diff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">correction</span> <span class="c1"># end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span><span class="p">[</span><span class="n">nr</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="o">-</span> <span class="n">correction</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Aqueduct 0.2.10 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../aqueduct.html" >aqueduct</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Tomasz Magdziarz.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>